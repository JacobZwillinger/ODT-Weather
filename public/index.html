<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oregon Desert Trail Weather</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 16px;
        background: #fff;
        color: #1b1b1b;
        font-size: 14px;
      }

      h1 {
        font-size: 1.4rem;
        margin: 0 0 4px;
        font-weight: 600;
      }

      .subtitle {
        margin: 0 0 16px;
        color: #666;
        font-size: 0.9rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #ccc;
      }

      th, td {
        border: 1px solid #ccc;
        padding: 8px 12px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #f5f5f5;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .location-name {
        font-weight: 500;
      }

      .coords {
        font-size: 0.8rem;
        margin-top: 2px;
      }

      .coords a {
        color: #0066cc;
        text-decoration: none;
      }

      .coords a:hover {
        text-decoration: underline;
      }

      .mile {
        text-align: center;
      }

      .forecast-cell {
        min-width: 80px;
        font-size: 0.85rem;
        color: #666;
      }

      .loading {
        padding: 20px;
        text-align: center;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>Oregon Desert Trail Weather</h1>
    <p class="subtitle">Key sections along the 750-mile Oregon Desert Trail, updated from PirateWeather.</p>

    <div id="container">
      <div class="loading">Loading forecasts...</div>
    </div>

    <script>
      const points = [
        // Region 1: Oregon Badlands to Paisley (161 mi)
        { name: "Oregon Badlands (Western Terminus)", lat: 43.954, lon: -121.015, mile: 0 },
        { name: "Christmas Valley", lat: 43.238, lon: -120.671, mile: 84 },
        { name: "Paisley", lat: 42.694, lon: -120.546, mile: 161 },

        // Region 2: Paisley to Frenchglen (214 mi)
        { name: "Hart Mountain Hot Springs", lat: 42.502, lon: -119.690, mile: 266 },
        { name: "Frenchglen", lat: 42.827, lon: -118.915, mile: 374 },

        // Region 3: Frenchglen to McDermitt (165 mi)
        { name: "Steens Mountain Summit", lat: 42.636, lon: -118.577, mile: 400 },
        { name: "Alvord Desert", lat: 42.535, lon: -118.456, mile: 420 },
        { name: "Fields", lat: 42.264, lon: -118.676, mile: 439 },
        { name: "Pueblo Mountains", lat: 42.099, lon: -118.651, mile: 480 },
        { name: "McDermitt", lat: 41.998, lon: -117.719, mile: 539 },

        // Region 4: McDermitt to Lake Owyhee (212 mi)
        { name: "Rome", lat: 42.838, lon: -117.627, mile: 661 },
        { name: "Lake Owyhee State Park (Eastern Terminus)", lat: 43.628, lon: -117.232, mile: 750 }
      ];

      const container = document.getElementById("container");

      // Get next 7 days starting from today
      const getDayHeaders = () => {
        const days = [];
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const today = new Date();

        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          const dayName = dayNames[date.getDay()];
          const month = date.getMonth() + 1;
          const day = date.getDate();
          days.push(`${dayName}, ${month}/${day}`);
        }
        return days;
      };

      const formatCoords = (lat, lon) => {
        const latStr = lat.toFixed(4);
        const lonStr = lon.toFixed(4);
        const googleUrl = `https://www.google.com/maps?q=${lat},${lon}`;
        return `<a href="${googleUrl}" target="_blank" rel="noopener">(${latStr}, ${lonStr})</a>`;
      };

      const renderTable = (forecasts) => {
        const dayHeaders = getDayHeaders();

        let html = `
          <table>
            <thead>
              <tr>
                <th>Location</th>
                <th>Mile</th>
                ${dayHeaders.map(d => `<th>${d}</th>`).join("")}
              </tr>
            </thead>
            <tbody>
        `;

        points.forEach((point, index) => {
          const forecast = forecasts[index];
          html += `
            <tr>
              <td>
                <div class="location-name">${point.name}</div>
                <div class="coords">${formatCoords(point.lat, point.lon)}</div>
              </td>
              <td class="mile">${point.mile.toFixed(1)}</td>
          `;

          // Add 7 day cells
          for (let i = 0; i < 7; i++) {
            if (forecast && forecast.daily && forecast.daily[i]) {
              const day = forecast.daily[i];
              const high = day.high !== undefined ? Math.round(day.high) : "--";
              const low = day.low !== undefined ? Math.round(day.low) : "--";
              const summary = day.summary || "";
              html += `<td class="forecast-cell">${high}° / ${low}°<br>${summary}</td>`;
            } else {
              html += `<td class="forecast-cell">Unable to load forecast.</td>`;
            }
          }

          html += `</tr>`;
        });

        html += `
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      };

      const loadForecasts = async () => {
        const forecasts = await Promise.all(
          points.map(async (point) => {
            try {
              const response = await fetch(
                `/api/forecast?lat=${point.lat}&lon=${point.lon}`
              );
              if (!response.ok) {
                throw new Error("Bad response");
              }
              return await response.json();
            } catch (error) {
              return null;
            }
          })
        );

        renderTable(forecasts);
      };

      loadForecasts();
    </script>
  </body>
</html>
