<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Oregon Desert Trail</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="lib/maplibre-gl.css" />
  </head>
  <body>
    <!-- Fullscreen map -->
    <div id="mapContainer"></div>

    <!-- Top-left kebab menu -->
    <div class="btn-group-top-left">
      <button id="btnKebab" aria-label="Menu">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="5" r="2" fill="currentColor"/>
          <circle cx="12" cy="12" r="2" fill="currentColor"/>
          <circle cx="12" cy="19" r="2" fill="currentColor"/>
        </svg>
      </button>
    </div>

    <!-- Kebab popover -->
    <div class="kebab-popover" id="kebabPopover" hidden>
      <div class="kebab-section">
        <label class="kebab-label" for="apiKeyInput">PirateWeather API Key</label>
        <div class="kebab-api-row">
          <input type="password" id="apiKeyInput" class="kebab-api-input" placeholder="Leave blank to use default" autocomplete="off" spellcheck="false"/>
          <button id="btnSaveApiKey" class="kebab-save-btn">Save</button>
        </div>
        <p class="kebab-hint" id="apiKeyHint"></p>
      </div>
      <div class="kebab-divider"></div>
      <div class="kebab-section">
        <button id="btnTestMode" class="kebab-toggle-btn" aria-pressed="false">
          <span class="kebab-toggle-indicator"></span>
          <span>Test Mode</span>
        </button>
      </div>
    </div>

    <!-- Top-right button group -->
    <div class="btn-group-top-right">
      <button id="btnElevation" aria-label="Elevation profile">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M2 20L8 10l4 5 4-8 6 13H2z" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </button>
      <button id="btnWeather" aria-label="Weather forecasts">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 19a4 4 0 0 1-.5-7.9 6 6 0 0 1 11.9.9H18a3 3 0 0 1 0 6H6z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" fill="none"/>
          <line x1="8" y1="22" x2="8" y2="24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="12" y1="22" x2="12" y2="24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="16" y1="22" x2="16" y2="24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="btnGpsCenter" aria-label="Center on GPS location">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="3" fill="currentColor"/>
          <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
          <line x1="12" y1="2" x2="12" y2="5" stroke="currentColor" stroke-width="2"/>
          <line x1="12" y1="19" x2="12" y2="22" stroke="currentColor" stroke-width="2"/>
          <line x1="2" y1="12" x2="5" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="19" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <!-- Bottom info bar -->
    <div class="bottom-info-bar" id="bottomInfoBar">
      <div class="info-group-pair">
        <div class="info-item">
          <span class="info-label" id="mileLabel">Mile</span>
          <span class="info-value info-value-mile" id="mapCurrentMile">0.0</span>
        </div>
        <div class="info-item info-item-nearest">
          <span class="info-label">Nearest</span>
          <span class="info-value info-value-nearest" id="mapNearestWaypoint">Start</span>
        </div>
      </div>
      <div class="info-item" id="nextReliableWaterCard" role="button" tabindex="0" aria-label="Next reliable water source">
        <svg class="info-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3c-2 3-5 6-5 9a5 5 0 0 0 10 0c0-3-3-6-5-9z" fill="#3b82f6"/>
        </svg>
        <span class="info-label">Reliable</span>
        <div class="info-value" id="mapNextReliableWater"><span>--</span></div>
      </div>
      <div class="info-item" id="nextOtherWaterCard" role="button" tabindex="0" aria-label="Next other water source">
        <svg class="info-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3c-2 3-5 6-5 9a5 5 0 0 0 10 0c0-3-3-6-5-9z" fill="#94a3b8"/>
        </svg>
        <span class="info-label">Other</span>
        <div class="info-value" id="mapNextOtherWater"><span>--</span></div>
      </div>
      <div class="info-item" id="nextTownCard" role="button" tabindex="0" aria-label="Next town, click for towns list">
        <svg class="info-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="#059669"/>
        </svg>
        <span class="info-label">Town</span>
        <div class="info-value" id="mapNextTown"><span>--</span></div>
      </div>
      <div class="info-item" id="nextSectionCard" role="button" tabindex="0" aria-label="Current trail section, click for sections list">
        <svg class="info-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" stroke="#7c3aed" stroke-width="2" stroke-linejoin="round" fill="none"/>
          <line x1="4" y1="22" x2="4" y2="15" stroke="#7c3aed" stroke-width="2"/>
        </svg>
        <span class="info-label">Section</span>
        <span class="info-value" id="mapCurrentSection">--</span>
      </div>
    </div>

    <!-- Bottom-right button group -->
    <div class="btn-group-bottom-right">
      <button id="btnWaypointList" aria-label="Waypoint list">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <line x1="4" y1="6" x2="20" y2="6" stroke="currentColor" stroke-width="2"/>
          <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="4" y1="18" x2="20" y2="18" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
      <button id="btnSettings" aria-label="Map layer settings">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <polygon points="12,2 22,8 12,14 2,8" stroke="currentColor" stroke-width="2" stroke-linejoin="round" fill="none"/>
          <polyline points="2,12 12,18 22,12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <polyline points="2,16 12,22 22,16" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
      <button id="btnGpsToggle" aria-label="Toggle GPS tracking" aria-pressed="false">
        <svg class="gps-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <polygon points="12,2 19,21 12,17 5,21" fill="currentColor"/>
        </svg>
      </button>
    </div>

    <!-- Settings popover -->
    <div class="settings-popover" id="settingsPopover" hidden>
      <button class="category-toggle-btn active" data-category="water-reliable" aria-label="Toggle reliable water sources" aria-pressed="true">
        <svg class="category-toggle-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3c-2 3-5 6.5-5 10a5 5 0 0 0 10 0c0-3.5-3-7-5-10z" fill="currentColor"/>
        </svg>
        <span class="category-toggle-label">Reliable Water</span>
      </button>
      <button class="category-toggle-btn active" data-category="water-other" aria-label="Toggle other water sources" aria-pressed="true">
        <svg class="category-toggle-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3c-2 3-5 6.5-5 10a5 5 0 0 0 10 0c0-3.5-3-7-5-10z" fill="currentColor"/>
        </svg>
        <span class="category-toggle-label">Other Water</span>
      </button>
      <button class="category-toggle-btn active" data-category="towns" aria-label="Toggle towns" aria-pressed="true">
        <svg class="category-toggle-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="currentColor"/>
        </svg>
        <span class="category-toggle-label">Towns</span>
      </button>
      <button class="category-toggle-btn" data-category="navigation" aria-label="Toggle navigation waypoints" aria-pressed="false">
        <svg class="category-toggle-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2 L20 20 L12 16 L4 20 Z" fill="currentColor"/>
        </svg>
        <span class="category-toggle-label">Nav</span>
      </button>
      <button class="category-toggle-btn active" data-category="toilets" aria-label="Toggle toilets" aria-pressed="true">
        <svg class="category-toggle-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="9" y="10" width="6" height="9" rx="1" fill="currentColor"/>
          <circle cx="12" cy="6" r="2.5" fill="currentColor"/>
        </svg>
        <span class="category-toggle-label">Toilets</span>
      </button>
    </div>

    <!-- Full-screen overlay: Elevation Profile -->
    <div class="fullscreen-overlay" id="elevationOverlay" hidden>
      <div class="overlay-header">
        <h3>Elevation Profile</h3>
      </div>
      <div class="overlay-body">
        <canvas id="mapElevationChart" role="img" aria-label="Elevation profile chart showing trail elevation"></canvas>
      </div>
      <!-- Floating circular buttons bottom-right, matching map button style -->
      <div class="elev-float-btns">
        <button id="btnElevJump" class="elev-float-btn" aria-label="Jump to my location" title="Jump to my location">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="3" fill="currentColor"/>
            <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
            <line x1="12" y1="2" x2="12" y2="5" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="19" x2="12" y2="22" stroke="currentColor" stroke-width="2"/>
            <line x1="2" y1="12" x2="5" y2="12" stroke="currentColor" stroke-width="2"/>
            <line x1="19" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
        <button class="overlay-close elev-float-btn" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Full-screen overlay: Weather -->
    <div class="fullscreen-overlay" id="weatherOverlay" hidden>
      <div class="overlay-header">
        <h3>Weather Forecasts</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btnMoon" class="moon-btn" aria-label="Moon phase">ðŸŒ™</button>
          <button class="overlay-close" aria-label="Close">Close</button>
        </div>
      </div>
      <div class="overlay-body">
        <div id="container" aria-live="polite">
          <div class="loading" role="status">Loading forecasts...</div>
        </div>
      </div>
    </div>

    <!-- Moon panel (shown inline below header when moon btn tapped) -->
    <div id="moonPanel" class="moon-panel" hidden>
      <div id="moonPanelContent"></div>
    </div>

    <!-- Full-screen overlay: Waypoint List -->
    <div class="fullscreen-overlay" id="waypointListOverlay" hidden>
      <div class="overlay-header">
        <h3>Waypoints</h3>
        <button class="overlay-close" aria-label="Close">Close</button>
      </div>
      <div class="overlay-filter-bar" id="waypointFilterBar">
        <button class="filter-btn active" data-filter="all-water">All Water</button>
        <button class="filter-btn" data-filter="reliable-water">Reliable Only</button>
        <button class="filter-btn" data-filter="towns">Towns</button>
        <button class="filter-btn" data-filter="navigation">Navigation</button>
        <button class="filter-btn" data-filter="toilets">Toilets</button>
        <button class="filter-btn" data-filter="sections">Sections</button>
      </div>
      <div class="overlay-body">
        <div id="waypointListContent" class="waypoint-list"></div>
      </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="sources-modal" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
      <div class="sources-modal-content">
        <div class="sources-modal-header">
          <h3 id="infoModalTitle">About This App</h3>
          <button class="sources-modal-close" id="closeInfoModal" aria-label="Close dialog">Close</button>
        </div>
        <div class="sources-list" style="max-height: none;">
          <div style="padding: 8px 0; line-height: 1.6;">
            <p style="margin: 0 0 16px;"><strong>Oregon Desert Trail Weather</strong> provides real-time weather forecasts for all 25 sections of the 750-mile Oregon Desert Trail.</p>

            <h4 style="margin: 24px 0 8px; font-size: 1rem; font-weight: 600;">Data Architecture</h4>
            <ul style="margin: 0 0 16px; padding-left: 20px;">
              <li style="margin-bottom: 8px;"><strong>Weather:</strong> PirateWeather API for hourly forecasts</li>
              <li style="margin-bottom: 8px;"><strong>Route & Waypoints:</strong> GPS coordinates from authoritative GPX files</li>
              <li style="margin-bottom: 8px;"><strong>Elevation:</strong> Profile data derived from USGS DEMs</li>
              <li style="margin-bottom: 8px;"><strong>Map Tiles:</strong> PMTiles vector basemap with contours</li>
            </ul>

            <h4 style="margin: 24px 0 8px; font-size: 1rem; font-weight: 600;">Features</h4>
            <ul style="margin: 0 0 16px; padding-left: 20px;">
              <li style="margin-bottom: 8px;">852 waypoints with precise GPS coordinates</li>
              <li style="margin-bottom: 8px;">325 water sources with reliability ratings</li>
              <li style="margin-bottom: 8px;">Interactive map with terrain visualization</li>
              <li style="margin-bottom: 8px;">Elevation profiles for route planning</li>
            </ul>

            <p style="margin: 16px 0 0; font-size: 0.9rem; color: #666;">Built for Oregon Desert Trail hikers. Data updated regularly.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Water/Town Sources Modal -->
    <div id="sourcesModal" class="sources-modal" role="dialog" aria-modal="true" aria-labelledby="sourcesModalTitle">
      <div class="sources-modal-content">
        <div class="sources-modal-header">
          <h3 id="sourcesModalTitle">Water Sources</h3>
          <button class="sources-modal-close" id="closeSourcesModal" aria-label="Close dialog">Close</button>
        </div>
        <div id="sourcesList" class="sources-list"></div>
      </div>
    </div>

    <!-- Waypoint Detail Modal -->
    <div id="waypointModal" class="sources-modal waypoint-modal" role="dialog" aria-modal="true" aria-labelledby="waypointModalTitle">
      <div class="sources-modal-content">
        <div class="sources-modal-header">
          <h3 id="waypointModalTitle">Waypoint</h3>
          <button class="sources-modal-close" id="closeWaypointModal" aria-label="Close dialog">Close</button>
        </div>
        <div id="waypointDetail" class="waypoint-detail"></div>
        <button id="viewOnMapBtn" class="view-on-map-btn" hidden>View on Map</button>
      </div>
    </div>

    <script src="lib/maplibre-gl.js"></script>
    <script src="lib/pmtiles.js"></script>
    <script type="module" src="js/app.js"></script>
  </body>
</html>
