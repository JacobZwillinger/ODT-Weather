<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oregon Desert Trail Weather</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 16px;
        background: #fff;
        color: #1b1b1b;
        font-size: 14px;
      }

      h1 {
        font-size: 1.4rem;
        margin: 0 0 4px;
        font-weight: 600;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }

      .header-left {
        flex: 1;
      }

      .subtitle {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
      }

      .api-usage {
        font-size: 0.75rem;
        color: #999;
        text-align: right;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }

      .tab-btn {
        padding: 8px 16px;
        border: 1px solid #ccc;
        background: #f5f5f5;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        color: #666;
      }

      .tab-btn:hover {
        background: #e5e5e5;
      }

      .tab-btn.active {
        background: #1b1b1b;
        color: #fff;
        border-color: #1b1b1b;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #ccc;
      }

      th, td {
        border: 1px solid #ccc;
        padding: 8px 12px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #f5f5f5;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .section-cell {
        width: 6px;
        padding: 0;
        border-right: none;
      }

      .section-indicator {
        width: 6px;
        height: 100%;
        min-height: 40px;
      }

      /* Section colors by region */
      .section-1, .section-2, .section-3, .section-4 { background: #22c55e; } /* Region 1: Central Oregon */
      .section-5, .section-6 { background: #84cc16; } /* Region 1-2 transition */
      .section-7, .section-8, .section-9, .section-10, .section-11, .section-12 { background: #3b82f6; } /* Region 2: West Basin */
      .section-13, .section-14, .section-15, .section-16, .section-17, .section-18, .section-19, .section-20 { background: #f59e0b; } /* Region 3: East Basin */
      .section-21, .section-22, .section-23, .section-24, .section-25 { background: #ef4444; } /* Region 4: Owyhee */

      .location-name {
        font-weight: 500;
      }

      .location-name a {
        color: inherit;
        text-decoration: none;
      }

      .location-name a:hover {
        color: #0066cc;
        text-decoration: underline;
      }

      .elevation {
        font-size: 0.8rem;
        color: #666;
        margin-top: 2px;
      }

      .mile {
        text-align: center;
      }

      .forecast-cell {
        min-width: 70px;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
      }

      .forecast-cell .icon {
        width: 28px;
        height: 28px;
        margin: 0 auto 4px;
        display: block;
      }

      .forecast-cell .temps {
        font-weight: 500;
        color: #333;
      }

      .loading {
        padding: 20px;
        text-align: center;
        color: #666;
        font-style: italic;
      }

      /* Water table specific styles */
      .water-source {
        font-weight: 500;
      }

      .water-details {
        font-size: 0.85rem;
        color: #666;
        margin-top: 2px;
      }

      .dist-warning {
        color: #dc2626;
        font-weight: 600;
      }

      .off-trail-badge {
        display: inline-block;
        background: #fef3c7;
        color: #92400e;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      /* Progress tab styles */
      .progress-container {
        max-width: 500px;
      }

      .progress-panel {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        background: #fafafa;
      }

      .progress-panel-label {
        font-size: 0.75rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .progress-panel-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1b1b1b;
      }

      .progress-panel-detail {
        font-size: 0.9rem;
        color: #666;
        margin-top: 4px;
      }

      .progress-slider-container {
        margin-bottom: 20px;
      }

      .progress-slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.85rem;
        color: #666;
      }

      .progress-slider {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: #e5e5e5;
        border-radius: 4px;
        outline: none;
      }

      .progress-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #1b1b1b;
        border-radius: 50%;
        cursor: pointer;
      }

      .progress-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #1b1b1b;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }

      .progress-current {
        text-align: center;
        font-size: 1.1rem;
        font-weight: 500;
        margin-top: 8px;
      }

      .progress-summary {
        text-align: center;
        padding: 12px;
        background: #f5f5f5;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #666;
      }

      .progress-warning {
        color: #dc2626;
      }

      .progress-complete {
        color: #16a34a;
      }

      .error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
      }

      .debug-toggle {
        margin-top: 20px;
        font-size: 0.85rem;
      }

      .debug-toggle button {
        background: none;
        border: 1px solid #ccc;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: #666;
      }

      .debug-table {
        margin-top: 12px;
        font-size: 0.8rem;
      }

      .debug-table table {
        width: 100%;
      }

      .debug-table th, .debug-table td {
        padding: 4px 8px;
      }

      /* Map tab styles */
      #mapContainer {
        height: calc(100vh - 140px);
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
      }

      .maplibregl-popup-content {
        padding: 8px 12px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 13px;
      }

      .maplibregl-popup-content strong {
        display: block;
        margin-bottom: 2px;
      }

      .maplibregl-popup-content .mile-marker {
        color: #666;
        font-size: 12px;
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" />
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <h1>Oregon Desert Trail Weather</h1>
        <p class="subtitle">All 25 sections of the 750-mile Oregon Desert Trail, updated from PirateWeather.</p>
      </div>
      <div class="api-usage" id="apiUsage"></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="weather">Weather</button>
      <button class="tab-btn" data-tab="water">Water</button>
      <button class="tab-btn" data-tab="progress">Progress</button>
      <button class="tab-btn" data-tab="elevation">Elevation</button>
      <button class="tab-btn" data-tab="map">Map</button>
    </div>

    <div id="weatherTab" class="tab-content active">
      <div id="container">
        <div class="loading">Loading forecasts...</div>
      </div>
    </div>

    <div id="waterTab" class="tab-content">
      <div id="waterContainer"></div>
    </div>

    <div id="progressTab" class="tab-content">
      <div id="progressContainer"></div>
    </div>

    <div id="elevationTab" class="tab-content">
      <canvas id="elevationChart" style="width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 8px;"></canvas>
    </div>

    <div id="mapTab" class="tab-content">
      <div id="mapContainer"></div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
    <script src="water-data.js"></script>
    <script src="progress.js"></script>
    <script>
      const points = [
        // Region 1: Central Oregon Volcanic
        { name: "1: Badlands to Sand Spring", lat: 44.045, lon: -121.038, mile: 0, elevation: 3406, section: 1 },
        { name: "2: Sand Spring to South Reservoir", lat: 43.708, lon: -120.847, mile: 36, elevation: 4944, section: 2 },
        { name: "3: South Reservoir to Lost Forest", lat: 43.521, lon: -120.777, mile: 53, elevation: 4833, section: 3 },
        { name: "4: Lost Forest to Burma Rim", lat: 43.379, lon: -120.374, mile: 81, elevation: 4426, section: 4 },
        { name: "5: Burma Rim to Diablo Peak North", lat: 43.202, lon: -120.278, mile: 99, elevation: 4524, section: 5 },
        { name: "6: Diablo Peak North to Paisley", lat: 43.053, lon: -120.564, mile: 127, elevation: 5220, section: 6 },

        // Region 2: West Basin and Range
        { name: "7: Paisley to Abert Rim South", lat: 42.694, lon: -120.546, mile: 161, elevation: 4366, section: 7 },
        { name: "8: Abert Rim South to Colvin Timbers", lat: 42.329, lon: -120.301, mile: 211, elevation: 4711, section: 8 },
        { name: "9: Colvin Timbers to Plush", lat: 42.507, lon: -120.202, mile: 242, elevation: 6512, section: 9 },
        { name: "10: Plush to Hart Mountain HQ", lat: 42.425, lon: -119.905, mile: 266, elevation: 4518, section: 10 },
        { name: "11: Hart Mountain HQ to Orejana Canyon", lat: 42.548, lon: -119.655, mile: 311, elevation: 5617, section: 11 },
        { name: "12: Orejana Canyon to Frenchglen", lat: 42.790, lon: -119.483, mile: 334, elevation: 5010, section: 12 },

        // Region 3: East Basin and Range
        { name: "13: Frenchglen to South Steens", lat: 42.825, lon: -118.914, mile: 374, elevation: 4196, section: 13 },
        { name: "14: South Steens to East Steens Road", lat: 42.657, lon: -118.728, mile: 393, elevation: 5348, section: 14 },
        { name: "15: East Steens Road to Fields", lat: 42.520, lon: -118.531, mile: 417, elevation: 4042, section: 15 },
        { name: "16: Fields to Denio Creek", lat: 42.265, lon: -118.675, mile: 438, elevation: 4226, section: 16 },
        { name: "17: Denio Creek to No Name Creek", lat: 42.002, lon: -118.634, mile: 467, elevation: 4255, section: 17 },
        { name: "18: No Name Creek to Oregon Canyon", lat: 42.042, lon: -118.352, mile: 486, elevation: 6227, section: 18 },
        { name: "19: Oregon Canyon to Hwy 95", lat: 42.116, lon: -117.984, mile: 517, elevation: 7726, section: 19 },
        { name: "20: Hwy 95 to Anderson Crossing", lat: 42.121, lon: -117.746, mile: 539, elevation: 4600, section: 20 },

        // Region 4: Owyhee Canyonlands
        { name: "21: Anderson Crossing to Three Forks", lat: 42.130, lon: -117.316, mile: 577, elevation: 5502, section: 21 },
        { name: "22: Three Forks to Rome", lat: 42.545, lon: -117.166, mile: 621, elevation: 3980, section: 22 },
        { name: "23: Rome to Lambert Rocks", lat: 42.839, lon: -117.628, mile: 661, elevation: 3383, section: 23 },
        { name: "24: Lambert Rocks to Leslie Gulch", lat: 43.064, lon: -117.681, mile: 684, elevation: 3389, section: 24 },
        { name: "25: Leslie Gulch to Owyhee Reservoir", lat: 43.299, lon: -117.270, mile: 725, elevation: 3517, section: 25 }
      ];

      const container = document.getElementById("container");

      // Get next 7 days starting from today
      const getDayHeaders = () => {
        const days = [];
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const today = new Date();

        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          const dayName = dayNames[date.getDay()];
          const month = date.getMonth() + 1;
          const day = date.getDate();
          days.push(`${dayName}, ${month}/${day}`);
        }
        return days;
      };

      const getMapUrl = (lat, lon) => {
        return `https://www.google.com/maps?q=${lat},${lon}`;
      };

      // Inline SVG weather icons - minimal file size, no external requests
      const icons = {
        "clear-day": `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>`,
        "clear-night": `<svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>`,
        "rain": `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M16 13v8M8 13v8M12 15v8"/><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af"/></svg>`,
        "snow": `<svg viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af"/><circle cx="8" cy="20" r="1" fill="#60a5fa"/><circle cx="12" cy="18" r="1" fill="#60a5fa"/><circle cx="16" cy="20" r="1" fill="#60a5fa"/></svg>`,
        "sleet": `<svg viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af"/><path d="M8 14v4M16 14v4"/><circle cx="12" cy="19" r="1" fill="#60a5fa"/></svg>`,
        "wind": `<svg viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><path d="M9.59 4.59A2 2 0 1111 8H2m10.59 11.41A2 2 0 1014 16H2m15.73-8.27A2.5 2.5 0 1119.5 12H2"/></svg>`,
        "fog": `<svg viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="M4 10h16M4 14h16M6 18h12"/></svg>`,
        "cloudy": `<svg viewBox="0 0 24 24" fill="none"><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"/></svg>`,
        "partly-cloudy-day": `<svg viewBox="0 0 24 24" fill="none"><circle cx="8" cy="8" r="3" fill="none" stroke="#f59e0b" stroke-width="2"/><path d="M8 2v1M8 13v1M3 8H2M14 8h1M4.22 4.22l.71.71M11.07 11.07l.71.71M4.22 11.78l.71-.71M11.07 4.93l.71-.71"/><path d="M10 13a4 4 0 01.09-.79 5 5 0 019.82.79h.09a2.5 2.5 0 110 5H10a2.5 2.5 0 110-5z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"/></svg>`,
        "partly-cloudy-night": `<svg viewBox="0 0 24 24" fill="none"><path d="M10 6a4 4 0 01-4 4 4 4 0 014-4z" stroke="#6366f1" stroke-width="2"/><path d="M10 13a4 4 0 01.09-.79 5 5 0 019.82.79h.09a2.5 2.5 0 110 5H10a2.5 2.5 0 110-5z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"/></svg>`
      };

      const getIcon = (iconName) => {
        return icons[iconName] || icons["cloudy"];
      };

      const renderTable = (forecasts) => {
        const dayHeaders = getDayHeaders();

        let html = `
          <table>
            <thead>
              <tr>
                <th class="section-cell"></th>
                <th>Location</th>
                <th>Mile</th>
                ${dayHeaders.map(d => `<th>${d}</th>`).join("")}
              </tr>
            </thead>
            <tbody>
        `;

        points.forEach((point, index) => {
          const forecast = forecasts[index];
          html += `
            <tr>
              <td class="section-cell"><div class="section-indicator section-${point.section}"></div></td>
              <td>
                <div class="location-name"><a href="${getMapUrl(point.lat, point.lon)}" target="_blank" rel="noopener">${point.name}</a></div>
                <div class="elevation">${point.elevation.toLocaleString()}′</div>
              </td>
              <td class="mile">${point.mile}</td>
          `;

          // Add 7 day cells
          for (let i = 0; i < 7; i++) {
            if (forecast && forecast.daily && forecast.daily[i]) {
              const day = forecast.daily[i];
              const high = day.high !== undefined ? Math.round(day.high) : "--";
              const low = day.low !== undefined ? Math.round(day.low) : "--";
              const icon = day.icon || "cloudy";
              html += `<td class="forecast-cell"><span class="icon">${getIcon(icon)}</span><span class="temps">${high}° / ${low}°</span></td>`;
            } else {
              html += `<td class="forecast-cell">--</td>`;
            }
          }

          html += `</tr>`;
        });

        html += `
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      };

      const loadForecasts = async () => {
        const forecasts = await Promise.all(
          points.map(async (point) => {
            try {
              const response = await fetch(
                `/api/forecast?lat=${point.lat}&lon=${point.lon}`
              );
              if (!response.ok) {
                throw new Error("Bad response");
              }
              return await response.json();
            } catch (error) {
              return null;
            }
          })
        );

        renderTable(forecasts);

        // Display API usage from the last forecast response
        const lastForecast = forecasts.find(f => f && f._usage && f._usage.calls !== null);
        if (lastForecast) {
          const { calls, limit } = lastForecast._usage;
          const usageText = limit
            ? `API: ${calls.toLocaleString()} / ${limit.toLocaleString()}`
            : `API calls: ${calls.toLocaleString()}`;
          document.getElementById('apiUsage').textContent = usageText;
        }
      };

      loadForecasts();

      const renderWaterTable = () => {
        let html = `
          <table>
            <thead>
              <tr>
                <th>Mile</th>
                <th>Next Water</th>
                <th>On Trail</th>
                <th>Off Trail</th>
                <th>Landmark / Water Source</th>
              </tr>
            </thead>
            <tbody>
        `;

        waterSources.forEach((source) => {
          const distClass = typeof source.distToNext === 'number' && source.distToNext >= 20 ? 'dist-warning' : '';
          const distDisplay = source.distToNext === '-' ? 'End' : `${source.distToNext} mi`;

          html += `
            <tr>
              <td class="mile">${source.mile}</td>
              <td class="mile ${distClass}">${distDisplay}</td>
              <td class="mile">${source.onTrail ? 'Y' : ''}</td>
              <td class="mile">${source.offTrailDist ? `${source.offTrailDist} mi` : (source.onTrail ? '' : '<span class="off-trail-badge">Off Trail</span>')}</td>
              <td>
                <div class="water-source">${source.landmark || source.details.replace(/^reliable:\s*/i, '')}</div>
                ${source.landmark ? `<div class="water-details">${source.details}</div>` : ''}
              </td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
        `;

        document.getElementById('waterContainer').innerHTML = html;
      };

      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;

          // Update button states
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update content visibility
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(tab + 'Tab').classList.add('active');
        });
      });

      // Render water table on load
      renderWaterTable();

      // Elevation profile chart
      const renderElevationChart = () => {
        const canvas = document.getElementById('elevationChart');
        const ctx = canvas.getContext('2d');

        // Set canvas size
        canvas.width = canvas.offsetWidth;
        canvas.height = 400;

        const padding = { top: 40, right: 40, bottom: 60, left: 60 };
        const chartWidth = canvas.width - padding.left - padding.right;
        const chartHeight = canvas.height - padding.top - padding.bottom;

        // Get elevation data
        const elevations = points.map(p => p.elevation);
        const miles = points.map(p => p.mile);
        const minElev = Math.min(...elevations);
        const maxElev = Math.max(...elevations);
        const maxMile = Math.max(...miles);

        // Scale functions
        const xScale = (mile) => padding.left + (mile / maxMile) * chartWidth;
        const yScale = (elev) => padding.top + chartHeight - ((elev - minElev) / (maxElev - minElev)) * chartHeight;

        // Clear canvas
        ctx.fillStyle = '#fafafa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw grid lines
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;

        // Horizontal grid lines (elevation)
        for (let i = 0; i <= 5; i++) {
          const elev = minElev + (maxElev - minElev) * (i / 5);
          const y = yScale(elev);
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartWidth, y);
          ctx.stroke();

          // Y-axis labels
          ctx.fillStyle = '#666';
          ctx.font = '12px system-ui';
          ctx.textAlign = 'right';
          ctx.fillText(Math.round(elev) + ' ft', padding.left - 10, y + 4);
        }

        // Vertical grid lines (distance)
        for (let i = 0; i <= 10; i++) {
          const mile = (maxMile / 10) * i;
          const x = xScale(mile);
          ctx.strokeStyle = '#e0e0e0';
          ctx.beginPath();
          ctx.moveTo(x, padding.top);
          ctx.lineTo(x, padding.top + chartHeight);
          ctx.stroke();

          // X-axis labels
          ctx.fillStyle = '#666';
          ctx.font = '12px system-ui';
          ctx.textAlign = 'center';
          ctx.fillText(Math.round(mile) + ' mi', x, padding.top + chartHeight + 20);
        }

        // Draw elevation profile
        ctx.beginPath();
        ctx.strokeStyle = '#e11d48';
        ctx.lineWidth = 2;

        points.forEach((point, i) => {
          const x = xScale(point.mile);
          const y = yScale(point.elevation);

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });

        ctx.stroke();

        // Fill area under line
        ctx.lineTo(xScale(points[points.length - 1].mile), padding.top + chartHeight);
        ctx.lineTo(xScale(points[0].mile), padding.top + chartHeight);
        ctx.closePath();
        ctx.fillStyle = 'rgba(225, 29, 72, 0.1)';
        ctx.fill();

        // Draw axes
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top);
        ctx.lineTo(padding.left, padding.top + chartHeight);
        ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
        ctx.stroke();

        // Axis labels
        ctx.fillStyle = '#333';
        ctx.font = 'bold 14px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Distance (miles)', padding.left + chartWidth / 2, canvas.height - 10);

        ctx.save();
        ctx.translate(15, padding.top + chartHeight / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('Elevation (feet)', 0, 0);
        ctx.restore();

        // Title
        ctx.font = 'bold 16px system-ui';
        ctx.fillText('Oregon Desert Trail Elevation Profile', canvas.width / 2, 25);
      };

      // Render elevation chart when tab is shown
      document.querySelector('[data-tab="elevation"]').addEventListener('click', () => {
        setTimeout(() => renderElevationChart(), 100);
      });

      // Map initialization
      let map = null;
      let mapInitialized = false;

      const initMap = () => {
        if (mapInitialized) return;
        mapInitialized = true;

        // Register PMTiles protocol
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol('pmtiles', protocol.tile);

        // Calculate bounds from route coordinates
        const routeCoords = points.map(p => [p.lon, p.lat]);
        const bounds = routeCoords.reduce((acc, coord) => {
          return [
            [Math.min(acc[0][0], coord[0]), Math.min(acc[0][1], coord[1])],
            [Math.max(acc[1][0], coord[0]), Math.max(acc[1][1], coord[1])]
          ];
        }, [[routeCoords[0][0], routeCoords[0][1]], [routeCoords[0][0], routeCoords[0][1]]]);

        // Create map with vector basemap + overlay
        map = new maplibregl.Map({
          container: 'mapContainer',
          style: {
            version: 8,
            glyphs: 'https://cdn.protomaps.com/fonts/pbf/{fontstack}/{range}.pbf',
            sources: {
              'basemap': {
                type: 'vector',
                url: 'pmtiles://basemap.pmtiles'
              },
              'overlay': {
                type: 'vector',
                url: 'pmtiles://overlay.pmtiles'
              }
            },
            layers: []
          },
          bounds: bounds,
          fitBoundsOptions: { padding: 40 }
        });

        map.on('load', () => {
          // Add basemap layers (OpenMapTiles standard layers)

          // Background
          map.addLayer({
            id: 'background',
            type: 'background',
            paint: {
              'background-color': '#f8f4f0'
            }
          });

          // Water polygons
          map.addLayer({
            id: 'water',
            type: 'fill',
            source: 'basemap',
            'source-layer': 'water',
            paint: {
              'fill-color': '#aad3df',
              'fill-opacity': 0.7
            }
          });

          // Landcover (parks, forests)
          map.addLayer({
            id: 'landcover',
            type: 'fill',
            source: 'basemap',
            'source-layer': 'landcover',
            paint: {
              'fill-color': '#d8e8c8',
              'fill-opacity': 0.3
            }
          });

          // Park areas
          map.addLayer({
            id: 'park',
            type: 'fill',
            source: 'basemap',
            'source-layer': 'park',
            paint: {
              'fill-color': '#d8e8c8',
              'fill-opacity': 0.4
            }
          });

          // Waterways (rivers, streams)
          map.addLayer({
            id: 'waterway',
            type: 'line',
            source: 'basemap',
            'source-layer': 'waterway',
            paint: {
              'line-color': '#aad3df',
              'line-width': [
                'interpolate',
                ['linear'],
                ['zoom'],
                8, 0.5,
                13, 2
              ]
            }
          });

          // Transportation (roads, tracks)
          map.addLayer({
            id: 'transportation',
            type: 'line',
            source: 'basemap',
            'source-layer': 'transportation',
            paint: {
              'line-color': [
                'match',
                ['get', 'class'],
                'motorway', '#fc8',
                'trunk', '#ffa',
                'primary', '#fdd',
                'secondary', '#fff',
                'track', '#d4b59e',
                '#ccc'
              ],
              'line-width': [
                'interpolate',
                ['exponential', 1.5],
                ['zoom'],
                5, 0.5,
                13, [
                  'match',
                  ['get', 'class'],
                  ['motorway', 'trunk'], 3,
                  ['primary'], 2,
                  ['track'], 1.5,
                  1
                ]
              ]
            }
          });

          // Place labels (towns, cities)
          map.addLayer({
            id: 'place',
            type: 'symbol',
            source: 'basemap',
            'source-layer': 'place',
            layout: {
              'text-field': ['get', 'name'],
              'text-size': [
                'interpolate',
                ['linear'],
                ['zoom'],
                6, 10,
                13, 16
              ],
              'text-font': ['Noto Sans Regular']
            },
            paint: {
              'text-color': '#333',
              'text-halo-color': '#fff',
              'text-halo-width': 2
            }
          });

          // Mountain peaks
          map.addLayer({
            id: 'mountain_peak',
            type: 'symbol',
            source: 'basemap',
            'source-layer': 'mountain_peak',
            minzoom: 11,
            layout: {
              'text-field': ['get', 'name'],
              'text-size': 10,
              'text-font': ['Noto Sans Regular'],
              'icon-image': 'triangle-11',
              'icon-size': 0.8
            },
            paint: {
              'text-color': '#666',
              'text-halo-color': '#fff',
              'text-halo-width': 1
            }
          });

          // Water labels
          map.addLayer({
            id: 'water_name',
            type: 'symbol',
            source: 'basemap',
            'source-layer': 'water_name',
            layout: {
              'text-field': ['get', 'name'],
              'text-size': 11,
              'text-font': ['Noto Sans Regular']
            },
            paint: {
              'text-color': '#5a80a0',
              'text-halo-color': '#fff',
              'text-halo-width': 1.5
            }
          });

          // Transportation labels (road names)
          map.addLayer({
            id: 'transportation_name',
            type: 'symbol',
            source: 'basemap',
            'source-layer': 'transportation_name',
            minzoom: 10,
            layout: {
              'text-field': ['get', 'name'],
              'text-size': 10,
              'symbol-placement': 'line',
              'text-font': ['Noto Sans Regular']
            },
            paint: {
              'text-color': '#666',
              'text-halo-color': '#fff',
              'text-halo-width': 2
            }
          });

          // Add route line layer from overlay
          map.addLayer({
            id: 'route-line',
            type: 'line',
            source: 'overlay',
            'source-layer': 'route',
            paint: {
              'line-color': '#e11d48',
              'line-width': 3,
              'line-opacity': 0.9
            }
          });

          // Add section markers from overlay
          map.addLayer({
            id: 'section-circles',
            type: 'circle',
            source: 'overlay',
            'source-layer': 'sections',
            paint: {
              'circle-radius': 8,
              'circle-color': '#1b1b1b',
              'circle-stroke-color': '#fff',
              'circle-stroke-width': 2
            }
          });

          // Add section number labels (always visible, compact)
          map.addLayer({
            id: 'section-numbers',
            type: 'symbol',
            source: 'overlay',
            'source-layer': 'sections',
            layout: {
              'text-field': ['slice', ['get', 'name'], 0, ['index-of', ':', ['get', 'name']]],
              'text-size': 10,
              'text-font': ['Noto Sans Regular'],
              'text-allow-overlap': true
            },
            paint: {
              'text-color': '#fff'
            }
          });

          // Add section full labels (only at higher zoom)
          map.addLayer({
            id: 'section-labels',
            type: 'symbol',
            source: 'overlay',
            'source-layer': 'sections',
            layout: {
              'text-field': ['get', 'name'],
              'text-size': 11,
              'text-offset': [0, 1.5],
              'text-anchor': 'top',
              'text-max-width': 12
            },
            paint: {
              'text-color': '#1b1b1b',
              'text-halo-color': '#fff',
              'text-halo-width': 1.5
            },
            minzoom: 9
          });

          // Add waypoint circles (smaller, shown at higher zoom)
          map.addLayer({
            id: 'waypoint-circles',
            type: 'circle',
            source: 'overlay',
            'source-layer': 'waypoints',
            paint: {
              'circle-radius': 4,
              'circle-color': '#3b82f6',
              'circle-stroke-color': '#fff',
              'circle-stroke-width': 1
            },
            minzoom: 10
          });
        });

        // Popup on section click
        map.on('click', 'section-circles', (e) => {
          const props = e.features[0].properties;
          new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${props.name}</strong><span class="mile-marker">Mile ${props.mile}</span>`)
            .addTo(map);
        });

        // Popup on waypoint click
        map.on('click', 'waypoint-circles', (e) => {
          const props = e.features[0].properties;
          new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${props.name}</strong>`)
            .addTo(map);
        });

        // Change cursor on hover
        map.on('mouseenter', 'section-circles', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'section-circles', () => map.getCanvas().style.cursor = '');
        map.on('mouseenter', 'waypoint-circles', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'waypoint-circles', () => map.getCanvas().style.cursor = '');

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
      };

      // Initialize map when tab is shown (lazy load)
      document.querySelector('[data-tab="map"]').addEventListener('click', () => {
        // Small delay to ensure container is visible
        setTimeout(initMap, 100);
      });
    </script>
  </body>
</html>
