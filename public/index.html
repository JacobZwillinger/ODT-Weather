<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oregon Desert Trail Weather</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" integrity="sha384-m6tadjb5ohv1Fw3GJynIWn5c1scKfW7kxSXuDrhlq1gdXPn7I7UL0sSKDfCUErOb" crossorigin="anonymous" />
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <h1>Oregon Desert Trail Weather</h1>
        <button class="info-btn" id="infoBtn" aria-label="About">i</button>
      </div>
      <div class="api-usage" id="apiUsage"></div>
    </div>

    <!-- [UX] Changed: Added role="tablist" and ARIA tab attributes for screen reader support (WCAG 4.1.2) -->
    <div class="tabs" role="tablist" aria-label="Main navigation">
      <button class="tab-btn active" data-tab="map" role="tab" aria-selected="true" aria-controls="mapTab" id="tab-map">Map</button>
      <button class="tab-btn" data-tab="weather" role="tab" aria-selected="false" aria-controls="weatherTab" id="tab-weather">Weather</button>
    </div>

    <div class="main-content">
      <!-- [UX] Changed: Added role="tabpanel" and aria-labelledby for tab/panel relationship (WCAG 4.1.2) -->
      <div id="mapTab" class="tab-content active" role="tabpanel" aria-labelledby="tab-map">
        <div id="mapContainer"></div>
        <div id="mapInfoPanel" class="map-info-panel">
          <div class="gps-toggle-section">
            <button class="gps-toggle-btn" id="gpsToggleBtn" aria-label="Toggle GPS" aria-pressed="false">
              <!-- [UX] Changed: Added aria-hidden to decorative SVG (WCAG 1.1.1) -->
              <svg class="gps-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="12" cy="12" r="3" fill="currentColor"/>
                <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                <line x1="12" y1="2" x2="12" y2="5" stroke="currentColor" stroke-width="2"/>
                <line x1="12" y1="19" x2="12" y2="22" stroke="currentColor" stroke-width="2"/>
                <line x1="2" y1="12" x2="5" y2="12" stroke="currentColor" stroke-width="2"/>
                <line x1="19" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
            <!-- [UX] Changed: Added aria-live so GPS status changes are announced (WCAG 4.1.3) -->
            <span class="gps-status" id="gpsStatus" aria-live="polite"></span>
          </div>
          <div class="map-info-current-section">
            <div class="map-info-current-label">Current Mile</div>
            <div class="map-info-current-mile" id="mapCurrentMile">0.0</div>
          </div>
          <div class="map-info-waypoint-section">
            <div class="map-info-waypoint-label">Nearest Waypoint</div>
            <div class="map-info-waypoint-value" id="mapNearestWaypoint">Start</div>
          </div>
          <div class="map-info-cards">
            <!-- [UX] Changed: Added role="button", tabindex, aria-label to make cards keyboard-accessible (WCAG 2.1.1) -->
            <div class="map-info-card" id="nextWaterCard" role="button" tabindex="0" aria-label="Next water source, click for water sources list">
              <svg class="map-info-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 3c-2 3-5 6-5 9a5 5 0 0 0 10 0c0-3-3-6-5-9z" fill="#3b82f6"/>
              </svg>
              <div class="map-info-value" id="mapNextWater">
                <span>--</span>
              </div>
            </div>
            <div class="map-info-card" id="nextTownCard" role="button" tabindex="0" aria-label="Next town, click for towns list">
              <svg class="map-info-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="#059669"/>
              </svg>
              <div class="map-info-value" id="mapNextTown">
                <span>--</span>
              </div>
            </div>
          </div>
        </div>

        <div class="map-elevation-chart">
          <h4>Next 20 Miles Elevation</h4>
          <canvas id="mapElevationChart" role="img" aria-label="Elevation profile chart showing the next 20 miles of trail elevation"></canvas>
        </div>
      </div>

      <div id="weatherTab" class="tab-content" role="tabpanel" aria-labelledby="tab-weather">
        <!-- [UX] Changed: Added aria-live for dynamic content updates, role="status" for loading (WCAG 4.1.3) -->
        <div id="container" aria-live="polite">
          <div class="loading" role="status">Loading forecasts...</div>
        </div>
      </div>
    </div>

    <!-- Info Modal -->
    <!-- [UX] Changed: Added role="dialog", aria-modal, aria-labelledby for screen readers (WCAG 4.1.2) -->
    <div id="infoModal" class="sources-modal" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
      <div class="sources-modal-content">
        <div class="sources-modal-header">
          <h3 id="infoModalTitle">About This App</h3>
          <button class="sources-modal-close" id="closeInfoModal" aria-label="Close dialog">Close</button>
        </div>
        <div class="sources-list" style="max-height: none;">
          <div style="padding: 8px 0; line-height: 1.6;">
            <p style="margin: 0 0 16px;"><strong>Oregon Desert Trail Weather</strong> provides real-time weather forecasts for all 25 sections of the 750-mile Oregon Desert Trail.</p>

            <h4 style="margin: 24px 0 8px; font-size: 1rem; font-weight: 600;">Data Architecture</h4>
            <ul style="margin: 0 0 16px; padding-left: 20px;">
              <li style="margin-bottom: 8px;"><strong>Weather:</strong> PirateWeather API for hourly forecasts</li>
              <li style="margin-bottom: 8px;"><strong>Route & Waypoints:</strong> GPS coordinates from authoritative GPX files</li>
              <li style="margin-bottom: 8px;"><strong>Elevation:</strong> Profile data derived from USGS DEMs</li>
              <li style="margin-bottom: 8px;"><strong>Map Tiles:</strong> PMTiles vector basemap with contours</li>
            </ul>

            <h4 style="margin: 24px 0 8px; font-size: 1rem; font-weight: 600;">Features</h4>
            <ul style="margin: 0 0 16px; padding-left: 20px;">
              <li style="margin-bottom: 8px;">852 waypoints with precise GPS coordinates</li>
              <li style="margin-bottom: 8px;">325 water sources with reliability ratings</li>
              <li style="margin-bottom: 8px;">Interactive map with terrain visualization</li>
              <li style="margin-bottom: 8px;">Elevation profiles for route planning</li>
            </ul>

            <p style="margin: 16px 0 0; font-size: 0.9rem; color: #666;">Built for Oregon Desert Trail hikers. Data updated regularly.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Water/Town Sources Modal -->
    <!-- [UX] Changed: Added role="dialog", aria-modal, aria-labelledby for screen readers (WCAG 4.1.2) -->
    <div id="sourcesModal" class="sources-modal" role="dialog" aria-modal="true" aria-labelledby="sourcesModalTitle">
      <div class="sources-modal-content">
        <div class="sources-modal-header">
          <h3 id="sourcesModalTitle">Water Sources</h3>
          <button class="sources-modal-close" id="closeSourcesModal" aria-label="Close dialog">Close</button>
        </div>
        <div id="sourcesList" class="sources-list"></div>
      </div>
    </div>

    <!-- Waypoint Detail Modal -->
    <!-- [UX] Changed: Added role="dialog", aria-modal, aria-labelledby for screen readers (WCAG 4.1.2) -->
    <div id="waypointModal" class="sources-modal waypoint-modal" role="dialog" aria-modal="true" aria-labelledby="waypointModalTitle">
      <div class="sources-modal-content">
        <div class="sources-modal-header">
          <h3 id="waypointModalTitle">Waypoint</h3>
          <button class="sources-modal-close" id="closeWaypointModal" aria-label="Close dialog">Close</button>
        </div>
        <div id="waypointDetail" class="waypoint-detail"></div>
      </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js" integrity="sha384-q3AR0wM1VzQVRuZgwc2pyYPArgjMNrAXLctZcYa7rBd1y1O1UanRgDrlJN913Gt5" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js" integrity="sha384-4sbA4B4Oqxkzs6apu8HaZcGrL3BySmt0tO/LQf6al3hkgq8ijZFxkTkvxxZZ/3PU" crossorigin="anonymous"></script>
    <script type="module" src="js/app.js"></script>
  </body>
</html>
