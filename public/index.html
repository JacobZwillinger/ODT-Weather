<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oregon Desert Trail Weather</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 16px;
        background: #fff;
        color: #1b1b1b;
        font-size: 14px;
      }

      h1 {
        font-size: 1.4rem;
        margin: 0 0 4px;
        font-weight: 600;
      }

      .subtitle {
        margin: 0 0 16px;
        color: #666;
        font-size: 0.9rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #ccc;
      }

      th, td {
        border: 1px solid #ccc;
        padding: 8px 12px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #f5f5f5;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .section-cell {
        width: 6px;
        padding: 0;
        border-right: none;
      }

      .section-indicator {
        width: 6px;
        height: 100%;
        min-height: 40px;
      }

      .section-1 { background: #22c55e; }
      .section-2 { background: #3b82f6; }
      .section-3 { background: #f59e0b; }
      .section-4 { background: #ef4444; }

      .location-name {
        font-weight: 500;
      }

      .location-name a {
        color: inherit;
        text-decoration: none;
      }

      .location-name a:hover {
        color: #0066cc;
        text-decoration: underline;
      }

      .elevation {
        font-size: 0.8rem;
        color: #666;
        margin-top: 2px;
      }

      .mile {
        text-align: center;
      }

      .forecast-cell {
        min-width: 70px;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
      }

      .forecast-cell .icon {
        width: 28px;
        height: 28px;
        margin: 0 auto 4px;
        display: block;
      }

      .forecast-cell .temps {
        font-weight: 500;
        color: #333;
      }

      .loading {
        padding: 20px;
        text-align: center;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>Oregon Desert Trail Weather</h1>
    <p class="subtitle">Key sections along the 750-mile Oregon Desert Trail, updated from PirateWeather.</p>

    <div id="container">
      <div class="loading">Loading forecasts...</div>
    </div>

    <script>
      const points = [
        // Region 1: Oregon Badlands to Paisley (161 mi)
        { name: "Oregon Badlands", lat: 43.954, lon: -121.015, mile: 0, elevation: 3595, section: 1 },
        { name: "Christmas Valley", lat: 43.238, lon: -120.671, mile: 84, elevation: 4321, section: 1 },
        { name: "Paisley", lat: 42.694, lon: -120.546, mile: 161, elevation: 4366, section: 1 },

        // Region 2: Paisley to Frenchglen (214 mi)
        { name: "Hart Mountain Hot Springs", lat: 42.502, lon: -119.690, mile: 266, elevation: 5945, section: 2 },
        { name: "Frenchglen", lat: 42.827, lon: -118.915, mile: 374, elevation: 4194, section: 2 },

        // Region 3: Frenchglen to McDermitt (165 mi)
        { name: "Steens Mountain Summit", lat: 42.636, lon: -118.577, mile: 400, elevation: 9738, section: 3 },
        { name: "Alvord Desert", lat: 42.535, lon: -118.456, mile: 420, elevation: 4006, section: 3 },
        { name: "Fields", lat: 42.264, lon: -118.676, mile: 439, elevation: 4232, section: 3 },
        { name: "Pueblo Mountains", lat: 42.099, lon: -118.651, mile: 480, elevation: 8632, section: 3 },
        { name: "McDermitt", lat: 41.998, lon: -117.719, mile: 539, elevation: 4432, section: 3 },

        // Region 4: McDermitt to Lake Owyhee (212 mi)
        { name: "Rome", lat: 42.838, lon: -117.627, mile: 661, elevation: 3390, section: 4 },
        { name: "Lake Owyhee State Park", lat: 43.628, lon: -117.232, mile: 750, elevation: 2782, section: 4 }
      ];

      const container = document.getElementById("container");

      // Get next 7 days starting from today
      const getDayHeaders = () => {
        const days = [];
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const today = new Date();

        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          const dayName = dayNames[date.getDay()];
          const month = date.getMonth() + 1;
          const day = date.getDate();
          days.push(`${dayName}, ${month}/${day}`);
        }
        return days;
      };

      const getMapUrl = (lat, lon) => {
        return `https://www.google.com/maps?q=${lat},${lon}`;
      };

      // Inline SVG weather icons - minimal file size, no external requests
      const icons = {
        "clear-day": `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>`,
        "clear-night": `<svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>`,
        "rain": `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M16 13v8M8 13v8M12 15v8"/><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af"/></svg>`,
        "snow": `<svg viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af"/><circle cx="8" cy="20" r="1" fill="#60a5fa"/><circle cx="12" cy="18" r="1" fill="#60a5fa"/><circle cx="16" cy="20" r="1" fill="#60a5fa"/></svg>`,
        "sleet": `<svg viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af"/><path d="M8 14v4M16 14v4"/><circle cx="12" cy="19" r="1" fill="#60a5fa"/></svg>`,
        "wind": `<svg viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><path d="M9.59 4.59A2 2 0 1111 8H2m10.59 11.41A2 2 0 1014 16H2m15.73-8.27A2.5 2.5 0 1119.5 12H2"/></svg>`,
        "fog": `<svg viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="M4 10h16M4 14h16M6 18h12"/></svg>`,
        "cloudy": `<svg viewBox="0 0 24 24" fill="none"><path d="M6 10a4 4 0 01.09-.79A6 6 0 1118 10h1a3 3 0 110 6H5a3 3 0 110-6z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"/></svg>`,
        "partly-cloudy-day": `<svg viewBox="0 0 24 24" fill="none"><circle cx="8" cy="8" r="3" fill="none" stroke="#f59e0b" stroke-width="2"/><path d="M8 2v1M8 13v1M3 8H2M14 8h1M4.22 4.22l.71.71M11.07 11.07l.71.71M4.22 11.78l.71-.71M11.07 4.93l.71-.71"/><path d="M10 13a4 4 0 01.09-.79 5 5 0 019.82.79h.09a2.5 2.5 0 110 5H10a2.5 2.5 0 110-5z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"/></svg>`,
        "partly-cloudy-night": `<svg viewBox="0 0 24 24" fill="none"><path d="M10 6a4 4 0 01-4 4 4 4 0 014-4z" stroke="#6366f1" stroke-width="2"/><path d="M10 13a4 4 0 01.09-.79 5 5 0 019.82.79h.09a2.5 2.5 0 110 5H10a2.5 2.5 0 110-5z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1.5"/></svg>`
      };

      const getIcon = (iconName) => {
        return icons[iconName] || icons["cloudy"];
      };

      const renderTable = (forecasts) => {
        const dayHeaders = getDayHeaders();

        let html = `
          <table>
            <thead>
              <tr>
                <th class="section-cell"></th>
                <th>Location</th>
                <th>Mile</th>
                ${dayHeaders.map(d => `<th>${d}</th>`).join("")}
              </tr>
            </thead>
            <tbody>
        `;

        points.forEach((point, index) => {
          const forecast = forecasts[index];
          html += `
            <tr>
              <td class="section-cell"><div class="section-indicator section-${point.section}"></div></td>
              <td>
                <div class="location-name"><a href="${getMapUrl(point.lat, point.lon)}" target="_blank" rel="noopener">${point.name}</a></div>
                <div class="elevation">${point.elevation.toLocaleString()}′</div>
              </td>
              <td class="mile">${point.mile}</td>
          `;

          // Add 7 day cells
          for (let i = 0; i < 7; i++) {
            if (forecast && forecast.daily && forecast.daily[i]) {
              const day = forecast.daily[i];
              const high = day.high !== undefined ? Math.round(day.high) : "--";
              const low = day.low !== undefined ? Math.round(day.low) : "--";
              const icon = day.icon || "cloudy";
              html += `<td class="forecast-cell"><span class="icon">${getIcon(icon)}</span><span class="temps">${high}° / ${low}°</span></td>`;
            } else {
              html += `<td class="forecast-cell">--</td>`;
            }
          }

          html += `</tr>`;
        });

        html += `
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      };

      const loadForecasts = async () => {
        const forecasts = await Promise.all(
          points.map(async (point) => {
            try {
              const response = await fetch(
                `/api/forecast?lat=${point.lat}&lon=${point.lon}`
              );
              if (!response.ok) {
                throw new Error("Bad response");
              }
              return await response.json();
            } catch (error) {
              return null;
            }
          })
        );

        renderTable(forecasts);
      };

      loadForecasts();
    </script>
  </body>
</html>
